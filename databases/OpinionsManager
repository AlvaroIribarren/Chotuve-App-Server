const Manager = require('./DBManager')
const UserManager = require('./UsersManager')

const opinions = 'opinions'

async function getAllOpinions(){
    try {
        const result = Manager.getRows(opinions);
        return result;
    } catch(e){
        console.log(e);
    }
}

async function getOpinionById(id){
    return await Manager.getIdFromTable(id, opinions);
}

async function getAllOpinionsFromVideo(video_id){
    const text = 'SELECT * FROM opinions WHERE video_id = ' + video_id;
    const res = await Manager.executeQueryInTableWithoutValues(text);
    console.log(res.rows);
    return res.rows;
}

async function insertOpinion(author_id, author_name, video_id, positive_opinion) {
    const id = await Manager.generateNewIdInTable(opinions);
    const text = 'INSERT INTO opinions(id, author_id, author_name, video_id, positive_opinion) ' +
        'VALUES($1, $2, $3, $4, $5)';
    const values = [id, author_id, author_name, video_id, positive_opinion];
    await Manager.executeQueryInTable(text, values);
    return id;
}

async function deleteOpinionById(id) {
    console.log("Deleting video");
    const text = 'DELETE FROM opinions WHERE id = ' + id;
    await Manager.executeQueryInTableWithoutValues(text);
}

async function deleteAllOpinionsFromVideo(video_id){
    console.log("Deleting all opinions");
    const text = 'DELETE FROM friends WHERE video_id = ' + video_id;
    await Manager.executeQueryInTableWithoutValues(text);
}

async function checkIfUserIsTryingToPostTheSameOpinion(author_id, video_id, positive_opinion) {
    const str1 = 'SELECT * FROM ' + opinions + ' WHERE';
    const str2 = ' author_id =' + author_id + ' AND video_id =' + video_id +
        ' AND positive_opinion =' + positive_opinion;
    const text = str1 + str2;
    const equalOpinion = await Manager.executeQueryInTableWithoutValues(text);
    return equalOpinion.rows.length > 0;
}

const OpinionManager = {}
OpinionManager.getAllOpinions = getAllOpinions;
OpinionManager.getOpinionById = getOpinionById;
OpinionManager.getAllOpinionsFromVideo = getAllOpinionsFromVideo;
OpinionManager.insertOpinion = insertOpinion;
OpinionManager.deleteOpinionById = deleteOpinionById;
OpinionManager.deleteAllOpinionsFromVideo = deleteAllOpinionsFromVideo;
OpinionManager.checkIfUserIsTryingToPostTheSameOpinion = checkIfUserIsTryingToPostTheSameOpinion;

module.exports = OpinionManager;